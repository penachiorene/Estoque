<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistema de Gestão de Películas - Rene Penachio</title>
    
    <!-- Mobile App Capable (iOS & Android) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-title" content="Estoque Películas">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6;
            /* iOS Safe Area handling */
            padding-bottom: env(safe-area-inset-bottom);
            -webkit-tap-highlight-color: transparent;
        }
        .priority-low { background-color: #fee2e2; color: #991b1b; } 
        .priority-high { background-color: #dcfce7; color: #166534; } 
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            /* Smooth scrolling for mobile */
            -webkit-overflow-scrolling: touch; 
            padding-top: 1rem;
            padding-bottom: 4rem; /* Space for mobile keyboard */
        }
        .modal-content {
            background-color: #fff;
            margin: auto;
            padding: 1.5rem;
            border-radius: 0.75rem;
            width: 95%;
            max-width: 1100px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .trend-up { color: #dc2626; } 
        .trend-down { color: #16a34a; } 
        .trend-neutral { color: #9ca3af; }

        /* Table Filter Inputs */
        .filter-input {
            width: 100%;
            padding: 0.35rem 0.5rem;
            font-size: 16px; /* Prevents iOS Zoom on focus */
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            margin-top: 0.25rem;
        }
        .filter-input:focus {
            outline: none;
            border-color: #6366f1;
            ring: 2px solid #e0e7ff;
        }
        
        /* Mobile Specific Adjustments */
        @media (max-width: 640px) {
            th, td {
                padding: 0.75rem 0.5rem;
            }
            .modal-content {
                width: 92%;
                padding: 1rem;
            }
        }

        /* Smooth scroll for tables */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="text-gray-800 select-none md:select-text">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40 pb-safe">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-xl md:text-2xl font-bold text-gray-900 leading-tight">Gestão de Estoque</h1>
                <p class="text-xs md:text-sm text-gray-500">Rene Penachio | Atualizado: Jan 2026</p>
            </div>
            <div class="flex flex-wrap justify-center gap-2 w-full md:w-auto">
                 <button onclick="openExportModal()" class="flex-1 md:flex-none bg-gray-800 hover:bg-gray-900 active:bg-gray-700 text-white px-3 py-2.5 rounded-lg font-medium transition shadow-sm flex items-center justify-center gap-2 text-sm touch-manipulation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    <span class="hidden sm:inline">Exportar</span> .XLS
                </button>
                <button onclick="initShoppingSession()" class="flex-1 md:flex-none bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white px-3 py-2.5 rounded-lg font-medium transition shadow-sm flex items-center justify-center gap-2 text-sm touch-manipulation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                    </svg>
                    Compras (18h)
                </button>
                <button onclick="calculateMedianReport()" class="flex-1 md:flex-none bg-emerald-600 hover:bg-emerald-700 active:bg-emerald-800 text-white px-3 py-2.5 rounded-lg font-medium transition shadow-sm flex items-center justify-center gap-2 text-sm touch-manipulation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    Previsão
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-4 md:py-6 pb-24">

        <!-- Manual Entry Section -->
        <div class="bg-white rounded-xl p-4 md:p-6 mb-6 border border-gray-200 shadow-sm">
            <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                Controle de Movimentação
            </h2>

            <div class="mb-4 flex items-center bg-gray-50 p-3 rounded-lg border border-gray-100 touch-manipulation" onclick="document.getElementById('newItemToggle').click()">
                <input type="checkbox" id="newItemToggle" onchange="toggleNewItemMode(); event.stopPropagation();" class="w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                <label for="newItemToggle" class="ml-3 text-sm text-gray-700 font-medium cursor-pointer select-none">Cadastrar Novo Produto</label>
            </div>

            <!-- Existing Item Mode -->
            <div id="existingItemArea" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end mb-4">
                <div class="md:col-span-12">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Selecione o Item</label>
                    <!-- Text-base prevents iOS zoom -->
                    <select id="manualItemSelect" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-base border bg-white appearance-none">
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <!-- New Item Mode -->
            <div id="newItemArea" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 items-end mb-4 bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <div class="col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Tipo <span class="text-red-500">*</span></label>
                    <input type="text" id="newType" placeholder="Ex: 3D Comum" class="w-full border-gray-300 rounded-lg shadow-sm text-base p-2 border">
                 </div>
                 <div class="col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Marca <span class="text-red-500">*</span></label>
                    <input type="text" id="newBrand" placeholder="Ex: Samsung" class="w-full border-gray-300 rounded-lg shadow-sm text-base p-2 border">
                 </div>
                 <div class="col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Modelo <span class="text-red-500">*</span></label>
                    <input type="text" id="newModel" placeholder="Ex: A54" class="w-full border-gray-300 rounded-lg shadow-sm text-base p-2 border">
                 </div>
                 <div class="col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Material <span class="text-red-500">*</span></label>
                    <select id="newMaterial" class="w-full border-gray-300 rounded-lg shadow-sm text-base p-2 border bg-white">
                        <option value="VIDRO">VIDRO</option>
                        <option value="CERÂMICA">CERÂMICA</option>
                        <option value="GEL">GEL</option>
                        <option value="PRIVACIDADE">PRIVACIDADE</option>
                    </select>
                 </div>
                 <div class="col-span-1 md:col-span-2 lg:col-span-1">
                    <label class="block text-xs font-medium text-gray-700 mb-1">Custo (Opcional)</label>
                    <input type="number" inputmode="decimal" step="0.01" id="newCost" placeholder="Padrão R$ 2,00" class="w-full border-gray-300 rounded-lg shadow-sm text-base p-2 border">
                 </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-12 gap-3 items-end">
                <div class="col-span-2 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Qtd.</label>
                    <!-- inputmode numeric for better mobile keyboard -->
                    <input type="number" inputmode="numeric" pattern="[0-9]*" id="manualQty" min="1" value="1" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 text-base border text-center font-bold">
                </div>
                <div class="col-span-1 md:col-span-5">
                    <button onclick="registerEntry()" class="w-full bg-green-600 active:bg-green-800 text-white font-medium py-3 px-2 rounded-lg transition flex flex-col md:flex-row justify-center items-center gap-1 shadow-sm touch-manipulation">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span class="text-xs md:text-base">COMPRAR</span>
                    </button>
                </div>
                <div class="col-span-1 md:col-span-5">
                    <button onclick="registerExit()" class="w-full bg-red-600 active:bg-red-800 text-white font-medium py-3 px-2 rounded-lg transition flex flex-col md:flex-row justify-center items-center gap-1 shadow-sm touch-manipulation">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                        <span class="text-xs md:text-base">VENDER</span>
                    </button>
                </div>
            </div>
            <div id="manualFeedback" class="hidden mt-3 p-3 rounded-lg text-sm border font-medium text-center"></div>
        </div>
        
        <div class="bg-white rounded-xl shadow overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="mainTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <!-- Sticky first column for stock on mobile if needed, but simple wrap is better -->
                            <th class="px-3 py-3 text-center text-xs font-bold text-gray-900 uppercase tracking-wider bg-gray-100 border-b-2 border-indigo-200 w-20">
                                Est.
                                <input type="number" inputmode="numeric" onkeyup="filterTable()" id="filterQty" class="filter-input text-center" placeholder="#">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[140px]">
                                Modelo / Marca
                                <input type="text" onkeyup="filterTable()" id="filterModel" class="filter-input" placeholder="Buscar...">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">
                                Tipo
                                <input type="text" onkeyup="filterTable()" id="filterType" class="filter-input" placeholder="Buscar...">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                                Material
                                <input type="text" onkeyup="filterTable()" id="filterMaterial" class="filter-input" placeholder="Buscar...">
                            </th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                                Ano
                                <input type="number" inputmode="numeric" onkeyup="filterTable()" id="filterYear" class="filter-input text-center" placeholder="Ano">
                            </th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">
                                Custo
                                <input type="text" disabled class="filter-input bg-gray-100 cursor-not-allowed border-transparent">
                            </th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[100px]">
                                Venda
                                <input type="text" disabled class="filter-input bg-gray-100 cursor-not-allowed border-transparent">
                            </th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Saiu
                                <input type="number" inputmode="numeric" onkeyup="filterTable()" id="filterSales" class="filter-input text-center" placeholder="#">
                            </th>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">
                                Status
                                <select onchange="filterTable()" id="filterStatus" class="filter-input text-center">
                                    <option value="">Todos</option>
                                    <option value="PRIORITÁRIO">Prioritário</option>
                                    <option value="NÃO PRIORITÁRIO">Ñ Prior.</option>
                                </select>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable" class="bg-white divide-y divide-gray-200">
                        <!-- Rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        <p class="mt-4 text-xs text-gray-500 text-center md:text-right px-4 pb-8">* Toque nos valores de preço ou saída para editar.</p>
    </main>

    <!-- Modal: Exportar Relatório -->
    <div id="exportModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h2 class="text-xl font-bold text-gray-900">Exportar Relatório</h2>
                <button onclick="closeModal('exportModal')" class="text-gray-400 hover:text-gray-600 text-3xl p-2">&times;</button>
            </div>
            
            <p class="text-sm text-gray-500 mb-4">Selecione as colunas para o Excel (.xls).</p>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="qty"> <span class="text-sm font-bold">Estoque</span></label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="type"> <span class="text-sm">Tipo</span></label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="model"> <span class="text-sm">Modelo</span></label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="brand"> <span class="text-sm">Marca</span></label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="material"> <span class="text-sm">Material</span></label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="year"> <span class="text-sm">Ano</span></label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="cost"> <span class="text-sm">Custo</span></label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="sale"> <span class="text-sm">Venda</span></label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="sales"> <span class="text-sm">Saída</span></label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded"><input type="checkbox" checked class="export-col w-5 h-5 rounded text-indigo-600" value="status"> <span class="text-sm">Status</span></label>
            </div>

            <div class="flex flex-col md:flex-row justify-end gap-3">
                <button onclick="closeModal('exportModal')" class="w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium">Cancelar</button>
                <button onclick="generateXLS()" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Baixar .XLS
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Relatório de Compras -->
    <div id="shoppingModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <div>
                    <h2 class="text-xl font-bold text-gray-900">Lista de Compras</h2>
                    <p class="text-sm text-gray-500">Reposição de estoque baixo.</p>
                </div>
                <button onclick="closeModal('shoppingModal')" class="text-gray-400 hover:text-gray-600 text-3xl p-2">&times;</button>
            </div>
            
            <h3 class="text-lg font-semibold text-green-800 mb-2 flex items-center gap-2">
                Itens Selecionados
            </h3>
            <div class="overflow-y-auto max-h-80 mb-6 border rounded-lg bg-gray-50">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-1/3">Item</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase">Est.</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase">Qtd.</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="shoppingListCart" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                <div id="emptyCartMsg" class="p-8 text-center text-sm text-gray-500 hidden flex flex-col items-center">
                    Lista vazia.
                </div>
            </div>

            <div id="unifiedActionArea" class="mb-8 hidden">
                <a id="unifiedCalendarLink" href="#" target="_blank" class="w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-bold py-4 px-4 rounded-lg flex justify-center items-center gap-2 transition shadow-md touch-manipulation">
                    AGENDAR NO GOOGLE AGENDA
                </a>
                <p class="text-xs text-center text-gray-500 mt-2">Cria uma tarefa com todos os itens.</p>
            </div>

            <h3 class="text-lg font-semibold text-amber-800 mb-2 flex items-center gap-2 border-t pt-4">
                Antigos / Não Prioritários
            </h3>
            <div class="overflow-y-auto max-h-40 border rounded-lg bg-amber-50">
                <table class="min-w-full divide-y divide-amber-200">
                    <thead class="bg-amber-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-amber-800 uppercase">Item</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-amber-800 uppercase">Est.</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-amber-800 uppercase">Ação</th>
                        </tr>
                    </thead>
                    <tbody id="shoppingListManual" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                 <div id="emptyManualMsg" class="p-4 text-center text-sm text-gray-500 hidden">Nenhum item antigo em falta.</div>
            </div>

            <div class="mt-6 flex justify-end">
                <button onclick="closeModal('shoppingModal')" class="w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Relatório de Mediana e Preços -->
    <div id="medianModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-900">Previsão Financeira</h2>
                <button onclick="closeModal('medianModal')" class="text-gray-400 hover:text-gray-600 text-3xl p-2">&times;</button>
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <p class="text-xs text-blue-600 font-semibold uppercase">Média Custo</p>
                    <p id="meanCostDisplay" class="text-lg font-bold text-blue-900">R$ 0,00</p>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <p class="text-xs text-blue-600 font-semibold uppercase">Mediana Custo</p>
                    <p id="medianCostDisplay" class="text-lg font-bold text-blue-900">R$ 0,00</p>
                </div>
                 <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                    <p class="text-xs text-green-600 font-semibold uppercase">Média Venda</p>
                    <p id="meanSaleDisplay" class="text-lg font-bold text-green-900">R$ 0,00</p>
                </div>
                 <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                    <p class="text-xs text-green-600 font-semibold uppercase">Mediana Venda</p>
                    <p id="medianSaleDisplay" class="text-lg font-bold text-green-900">R$ 0,00</p>
                </div>
            </div>

            <h3 class="text-lg font-semibold text-gray-800 mb-2">Análise Detalhada</h3>
            <p class="text-xs text-gray-500 mb-2">Margem de lucro de 100% sobre o custo (respeitando piso).</p>
            <div class="overflow-y-auto max-h-96 border rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Modelo</th>
                            <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase">Custo</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase">Evol.</th>
                            <th class="px-2 py-3 text-right text-xs font-medium text-gray-500 uppercase">Venda Atual</th>
                            <th class="px-2 py-3 text-right text-xs font-medium text-indigo-700 uppercase">Sugerido</th>
                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody id="medianListBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
             <div class="mt-6 flex justify-end">
                <button onclick="closeModal('medianModal')" class="w-full md:w-auto bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-medium">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // Data Source
        const inventoryData = [
            { type: "3D PRIVACIDADE", model: "IP 14 PRO MAX", brand: "IPHONE", material: "VIDRO", qty: 1, year: 2022, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D PRIVACIDADE", model: "IP 14", brand: "IPHONE", material: "VIDRO", qty: 1, year: 2022, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D PRIVACIDADE", model: "IP 13 MINI", brand: "IPHONE", material: "VIDRO", qty: 1, year: 2021, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D CERÂMICA", model: "IP XS MAX / IP 11 PRO MAX", brand: "IPHONE", material: "CERÂMICA", qty: 2, year: 2019, sales: 0, cost: 2.00, lastCost: 2.00, sale: 35.00 },
            { type: "3D CERÂMICA", model: "24 PLUS", brand: "SAMSUNG", material: "CERÂMICA", qty: 2, year: 2024, sales: 0, cost: 2.00, lastCost: 2.00, sale: 35.00 },
            { type: "3D COMUM", model: "A 24 4G", brand: "SAMSUNG", material: "VIDRO", qty: 1, year: 2023, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "A 10", brand: "SAMSUNG", material: "VIDRO", qty: 1, year: 2019, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "A 31", brand: "SAMSUNG", material: "VIDRO", qty: 1, year: 2020, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "REDMI 14C", brand: "REDMI", material: "VIDRO", qty: 5, year: 2024, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "POCO M3", brand: "REDMI", material: "VIDRO", qty: 5, year: 2020, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "REDMI 9T", brand: "REDMI", material: "VIDRO", qty: 1, year: 2021, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "REDMI POCO 9 SE", brand: "REDMI", material: "VIDRO", qty: 1, year: 2019, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "REDMI NOTE 7", brand: "REDMI", material: "VIDRO", qty: 1, year: 2019, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "REDMI 8T", brand: "REDMI", material: "VIDRO", qty: 1, year: 2019, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "REDMI POCO M5", brand: "REDMI", material: "VIDRO", qty: 1, year: 2022, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "REDMI 9 LITE", brand: "REDMI", material: "VIDRO", qty: 1, year: 2019, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "ZENFONE ZB 633 MAX M2", brand: "ZENFONE", material: "VIDRO", qty: 1, year: 2019, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "REDMI 14 C", brand: "REDMI", material: "VIDRO", qty: 1, year: 2024, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 },
            { type: "3D COMUM", model: "MOTO ONE", brand: "MOTOROLA", material: "VIDRO", qty: 1, year: 2018, sales: 0, cost: 2.00, lastCost: 2.00, sale: 30.00 }
        ];

        // --- INTERNAL DATABASE FOR YEAR "SEARCH" ---
        const phoneDatabase = {
            "IPHONE 15": 2023, "IPHONE 15 PRO": 2023, "IPHONE 15 PRO MAX": 2023, "IPHONE 15 PLUS": 2023,
            "IPHONE 14": 2022, "IPHONE 14 PRO": 2022, "IPHONE 14 PRO MAX": 2022, "IPHONE 14 PLUS": 2022,
            "IPHONE 13": 2021, "IPHONE 13 MINI": 2021, "IPHONE 13 PRO": 2021, "IPHONE 13 PRO MAX": 2021,
            "IPHONE 12": 2020, "IPHONE 12 MINI": 2020, "IPHONE 12 PRO": 2020, "IPHONE 12 PRO MAX": 2020,
            "IPHONE 11": 2019, "IPHONE 11 PRO": 2019, "IPHONE 11 PRO MAX": 2019,
            "IPHONE X": 2017, "IPHONE XS": 2018, "IPHONE XR": 2018, "IPHONE XS MAX": 2018,
            "S24": 2024, "S24 PLUS": 2024, "S24 ULTRA": 2024,
            "S23": 2023, "S23 PLUS": 2023, "S23 ULTRA": 2023, "S23 FE": 2023,
            "S22": 2022, "S22 PLUS": 2022, "S22 ULTRA": 2022,
            "S21": 2021, "S21 FE": 2022, "S20": 2020, "S20 FE": 2020,
            "A55": 2024, "A35": 2024,
            "A54": 2023, "A34": 2023, "A24": 2023, "A14": 2023, "M54": 2023, "M14": 2023,
            "A53": 2022, "A33": 2022, "A23": 2022, "A13": 2022, "M53": 2022,
            "A52": 2021, "A32": 2021, "A22": 2021, "A12": 2020, "A02": 2021,
            "A51": 2019, "A71": 2019, "A31": 2020, "A21": 2020, "A11": 2020,
            "A10": 2019, "A20": 2019, "A30": 2019, "A50": 2019, "A70": 2019,
            "REDMI NOTE 13": 2024, "REDMI NOTE 13 PRO": 2024,
            "REDMI NOTE 12": 2023, "REDMI NOTE 12 PRO": 2023, "REDMI 12": 2023, "REDMI 12C": 2023,
            "REDMI NOTE 11": 2022, "REDMI NOTE 11S": 2022, "REDMI 10": 2021, "REDMI 10C": 2022,
            "REDMI NOTE 10": 2021, "REDMI NOTE 10S": 2021, "REDMI NOTE 10 PRO": 2021,
            "REDMI NOTE 9": 2020, "REDMI 9": 2020, "REDMI 9T": 2021, "REDMI 9A": 2020, "REDMI 9C": 2020,
            "REDMI NOTE 8": 2019, "REDMI NOTE 8T": 2019, "REDMI 8": 2019, "REDMI 8A": 2019,
            "REDMI NOTE 7": 2019, "REDMI 7": 2019,
            "POCO X6": 2024, "POCO X5": 2023, "POCO F5": 2023,
            "POCO X4": 2022, "POCO M5": 2022, "POCO M4": 2021,
            "POCO X3": 2020, "POCO M3": 2020, "POCO F3": 2021,
            "MOTO G84": 2023, "MOTO G54": 2023, "MOTO G14": 2023,
            "MOTO G53": 2022, "MOTO G23": 2023, "MOTO G73": 2023,
            "MOTO G52": 2022, "MOTO G42": 2022, "MOTO G22": 2022,
            "MOTO G60": 2021, "MOTO G30": 2021, "MOTO G10": 2021,
            "MOTO G9": 2020, "MOTO G8": 2020, "MOTO ONE": 2018, "MOTO ONE ACTION": 2019
        };

        function lookupYear(model, brand) {
            const cleanModel = model.toUpperCase().replace(/[-\/]/g, ' ').trim();
            const brandPrefix = brand.toUpperCase() + " ";
            if (phoneDatabase[cleanModel]) return phoneDatabase[cleanModel];
            if (phoneDatabase[brandPrefix + cleanModel]) return phoneDatabase[brandPrefix + cleanModel];
            for (let key in phoneDatabase) {
                if (cleanModel.includes(key) || key.includes(cleanModel)) {
                    return phoneDatabase[key];
                }
            }
            return 2026; 
        }

        let filteredData = [...inventoryData]; 
        let sessionApprovals = new Set();
        let shoppingCart = [];

        function isPriority(item) {
            if (item.year >= 2021) return true;
            return false;
        }

        function populateManualSelect() {
            const select = document.getElementById('manualItemSelect');
            select.innerHTML = '';
            const sortedItems = [...inventoryData].sort((a, b) => {
                if (a.brand < b.brand) return -1;
                if (a.brand > b.brand) return 1;
                return a.model.localeCompare(b.model);
            });
            sortedItems.forEach((item, index) => {
                const originalIndex = inventoryData.indexOf(item);
                const opt = document.createElement('option');
                opt.value = originalIndex;
                opt.text = `${item.brand} - ${item.model} (${item.material})`;
                select.appendChild(opt);
            });
        }

        function toggleNewItemMode() {
            const isNew = document.getElementById('newItemToggle').checked;
            const existingArea = document.getElementById('existingItemArea');
            const newArea = document.getElementById('newItemArea');
            if (isNew) {
                existingArea.classList.add('hidden');
                newArea.classList.remove('hidden');
                newArea.classList.add('grid');
            } else {
                existingArea.classList.remove('hidden');
                newArea.classList.add('hidden');
                newArea.classList.remove('grid');
            }
        }

        function createNewItemFromInputs() {
            const type = document.getElementById('newType').value.trim().toUpperCase();
            const brand = document.getElementById('newBrand').value.trim().toUpperCase();
            const model = document.getElementById('newModel').value.trim().toUpperCase();
            const material = document.getElementById('newMaterial').value;
            let enteredCost = parseFloat(document.getElementById('newCost').value);
            
            if (!type || !brand || !model) {
                showManualFeedback('⚠️ Preencha os campos obrigatórios (*).', 'error');
                return null;
            }
            if (isNaN(enteredCost) || enteredCost <= 0) enteredCost = 2.00;
            const foundYear = lookupYear(model, brand);
            let baseSale = 30.00;
            if (material === 'CERÂMICA') baseSale = 35.00;

            const newItem = {
                type: type, model: model, brand: brand, material: material,
                qty: 0, year: foundYear, sales: 0,
                cost: enteredCost, lastCost: enteredCost, sale: baseSale
            };
            inventoryData.push(newItem);
            document.getElementById('newType').value = '';
            document.getElementById('newBrand').value = '';
            document.getElementById('newModel').value = '';
            document.getElementById('newCost').value = '';
            populateManualSelect(); 
            return newItem;
        }

        function registerEntry() {
            const isNewMode = document.getElementById('newItemToggle').checked;
            const qty = parseInt(document.getElementById('manualQty').value);
            if (isNaN(qty) || qty <= 0) {
                 showManualFeedback('⚠️ Qtd inválida.', 'error');
                 return;
            }
            let item;
            if (isNewMode) {
                item = createNewItemFromInputs();
                if (!item) return; 
            } else {
                const index = document.getElementById('manualItemSelect').value;
                if (index === "") { showManualFeedback('⚠️ Selecione um item.', 'error'); return; }
                item = inventoryData[index];
            }
            item.qty += qty;
            showManualFeedback(`✅ +${qty} ${item.model}. Novo Est.: ${item.qty}`, 'success');
            filterTable();
        }

        function registerExit() {
            const isNewMode = document.getElementById('newItemToggle').checked;
            const qty = parseInt(document.getElementById('manualQty').value);
            if (isNaN(qty) || qty <= 0) {
                 showManualFeedback('⚠️ Qtd inválida.', 'error');
                 return;
            }
            let item;
            if (isNewMode) {
                item = createNewItemFromInputs();
                if (!item) return;
            } else {
                 const index = document.getElementById('manualItemSelect').value;
                if (index === "") { showManualFeedback('⚠️ Selecione um item.', 'error'); return; }
                item = inventoryData[index];
            }
            item.qty -= qty;
            item.sales += qty;
            showManualFeedback(`✅ -${qty} ${item.model}. Novo Est.: ${item.qty}`, 'success');
            filterTable();
        }

        function showManualFeedback(msg, type) {
            const el = document.getElementById('manualFeedback');
            el.innerHTML = msg;
            el.className = `mt-3 p-3 rounded-lg text-sm border block ${type === 'success' ? 'bg-green-50 text-green-800 border-green-200' : 'bg-red-50 text-red-800 border-red-200'}`;
            setTimeout(() => { el.className = 'hidden mt-3 p-3 rounded-lg text-sm border font-medium text-center'; }, 3000);
        }

        function filterTable() {
            const fType = document.getElementById('filterType').value.toLowerCase();
            const fModel = document.getElementById('filterModel').value.toLowerCase();
            const fMaterial = document.getElementById('filterMaterial') ? document.getElementById('filterMaterial').value.toLowerCase() : '';
            const fYear = document.getElementById('filterYear') ? document.getElementById('filterYear').value : '';
            const fQty = document.getElementById('filterQty').value;
            const fSales = document.getElementById('filterSales').value;
            const fStatus = document.getElementById('filterStatus').value;

            filteredData = inventoryData.filter(item => {
                const priority = isPriority(item);
                const statusText = priority ? 'PRIORITÁRIO' : 'NÃO PRIORITÁRIO';
                const matchType = item.type.toLowerCase().includes(fType);
                const matchModel = (item.model + ' ' + item.brand).toLowerCase().includes(fModel);
                const matchMaterial = fMaterial ? item.material.toLowerCase().includes(fMaterial) : true;
                const matchYear = fYear ? item.year.toString().includes(fYear) : true;
                const matchQty = fQty ? item.qty <= parseInt(fQty) : true;
                const matchSales = fSales ? item.sales >= parseInt(fSales) : true;
                const matchStatus = fStatus ? statusText === fStatus : true;
                return matchType && matchModel && matchMaterial && matchYear && matchQty && matchSales && matchStatus;
            });
            renderTable();
        }

        function openExportModal() { document.getElementById('exportModal').style.display = 'block'; }

        function generateXLS() {
            const checkboxes = document.querySelectorAll('.export-col:checked');
            const selectedCols = Array.from(checkboxes).map(cb => cb.value);
            const colMap = { type: 'Tipo', model: 'Modelo', brand: 'Marca', material: 'Material', year: 'Ano', cost: 'Custo', sale: 'Venda', qty: 'Estoque', sales: 'Saída', status: 'Status' };
            let table = '<table><thead><tr>';
            selectedCols.forEach(col => { table += `<th>${colMap[col]}</th>`; });
            table += '</tr></thead><tbody>';
            filteredData.forEach(item => {
                table += '<tr>';
                selectedCols.forEach(col => {
                    let val = '';
                    if (col === 'status') val = isPriority(item) ? 'PRIORITÁRIO' : 'NÃO PRIORITÁRIO';
                    else if (col === 'cost' || col === 'sale') val = item[col].toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    else val = item[col];
                    table += `<td>${val}</td>`;
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            const blob = new Blob(['\ufeff', table], { type: 'application/vnd.ms-excel;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const downloadLink = document.createElement("a");
            downloadLink.href = url;
            downloadLink.download = "Relatorio_Estoque.xls";
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            closeModal('exportModal');
        }

        function renderTable() {
            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = '';
            filteredData.forEach((item) => {
                const originalIndex = inventoryData.indexOf(item);
                const priority = isPriority(item);
                const statusClass = priority ? 'priority-high' : 'priority-low';
                const statusText = priority ? 'PRIORITÁRIO' : 'Ñ PRIORIT.';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-3 py-3 text-sm font-bold text-center ${item.qty <= 1 ? 'text-red-600' : 'text-gray-900'} text-lg">${item.qty}</td>
                    <td class="px-4 py-3 text-sm text-gray-700">
                        <div class="font-bold">${item.model}</div>
                        <div class="text-xs text-gray-500">${item.brand}</div>
                    </td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.type}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 hidden md:table-cell">${item.material}</td>
                    <td class="px-4 py-3 text-sm text-gray-500 text-center hidden md:table-cell">${item.year}</td>
                    <td class="px-4 py-3 text-sm text-gray-700 text-right cursor-pointer active:text-indigo-600" onclick="editPrice(${originalIndex}, 'cost')">
                        R$ ${item.cost.toFixed(2)}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-700 text-right cursor-pointer active:text-indigo-600" onclick="editPrice(${originalIndex}, 'sale')">
                        R$ ${item.sale.toFixed(2)}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-500 text-center cursor-pointer active:bg-gray-100" onclick="editSales(${originalIndex})">
                        ${item.sales}
                    </td>
                    <td class="px-4 py-3 text-center hidden md:table-cell">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editSales(index) {
            const currentSales = inventoryData[index].sales;
            const newVal = prompt(`Atualizar vendas:`, currentSales);
            if (newVal !== null && !isNaN(newVal)) {
                inventoryData[index].sales = parseInt(newVal);
                filterTable();
            }
        }

        function editPrice(index, type) {
            const item = inventoryData[index];
            const currentVal = type === 'cost' ? item.cost : item.sale;
            const label = type === 'cost' ? 'Custo' : 'Venda';
            const newVal = prompt(`Alterar ${label}:`, currentVal);
            if (newVal !== null && !isNaN(parseFloat(newVal))) {
                const val = parseFloat(newVal);
                if (type === 'cost') { item.lastCost = item.cost; item.cost = val; }
                else { item.sale = val; }
                filterTable();
            }
        }

        function initShoppingSession() {
            shoppingCart = [];
            const lowStockItems = inventoryData.filter(item => item.qty <= 1);
            lowStockItems.forEach(item => {
                const isItemPriority = isPriority(item);
                const itemKey = item.model;
                const isApproved = sessionApprovals.has(itemKey);
                if (isItemPriority || isApproved) shoppingCart.push({ item: item, buyQty: 5 });
            });
            renderShoppingModal();
            document.getElementById('shoppingModal').style.display = 'block';
        }
        
        function renderShoppingModal() {
            const cartListBody = document.getElementById('shoppingListCart');
            const manualListBody = document.getElementById('shoppingListManual');
            cartListBody.innerHTML = '';
            manualListBody.innerHTML = '';
            if (shoppingCart.length === 0) {
                document.getElementById('emptyCartMsg').style.display = 'flex';
                document.getElementById('unifiedActionArea').classList.add('hidden');
            } else {
                document.getElementById('emptyCartMsg').style.display = 'none';
                document.getElementById('unifiedActionArea').classList.remove('hidden');
                shoppingCart.forEach((cartItem, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900 font-bold">${cartItem.item.model}</td>
                        <td class="px-2 py-3 text-center text-sm text-red-600 font-bold">${cartItem.item.qty}</td>
                        <td class="px-2 py-3 text-center">
                            <div class="flex items-center justify-center gap-1">
                                <button onclick="updateCartQty(${index}, -1)" class="w-8 h-8 bg-gray-200 rounded text-lg font-bold">-</button>
                                <span class="w-8 text-center font-bold">${cartItem.buyQty}</span>
                                <button onclick="updateCartQty(${index}, 1)" class="w-8 h-8 bg-gray-200 rounded text-lg font-bold">+</button>
                            </div>
                        </td>
                        <td class="px-2 py-3 text-center">
                            <button onclick="removeFromCart(${index})" class="text-red-500 font-bold text-xl">&times;</button>
                        </td>
                    `;
                    cartListBody.appendChild(tr);
                });
                updateUnifiedLink();
            }
            const allLowStock = inventoryData.filter(item => item.qty <= 1);
            const itemsNotInCart = allLowStock.filter(lsItem => !shoppingCart.some(cartItem => cartItem.item === lsItem));
            if (itemsNotInCart.length === 0) { document.getElementById('emptyManualMsg').style.display = 'block'; }
            else {
                 document.getElementById('emptyManualMsg').style.display = 'none';
                 itemsNotInCart.forEach(item => {
                     const tr = document.createElement('tr');
                     tr.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.model}</td>
                        <td class="px-2 py-3 text-center text-sm font-bold text-red-600">${item.qty}</td>
                        <td class="px-2 py-3 text-center">
                            <button onclick="addToCartManual('${item.model}')" class="bg-indigo-50 text-indigo-700 text-xs font-bold px-3 py-1 rounded border">Add</button>
                        </td>
                     `;
                     manualListBody.appendChild(tr);
                 });
            }
        }

        function updateCartQty(index, delta) {
            const newQty = shoppingCart[index].buyQty + delta;
            if (newQty >= 1) { shoppingCart[index].buyQty = newQty; renderShoppingModal(); }
        }
        function removeFromCart(index) { shoppingCart.splice(index, 1); renderShoppingModal(); }
        function addToCartManual(modelName) {
            const item = inventoryData.find(i => i.model === modelName);
            if (item) { sessionApprovals.add(modelName); shoppingCart.push({ item: item, buyQty: 5 }); renderShoppingModal(); }
        }
        function updateUnifiedLink() {
            let itemListText = "LISTA DE REPOSIÇÃO:\n\n";
            shoppingCart.forEach(c => { itemListText += `- ${c.item.model} (${c.item.brand}): ${c.buyQty} un.\n`; });
            const title = "[Tarefa] - COMPRA DE ESTOQUE: Películas";
            const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent(itemListText)}`;
            document.getElementById('unifiedCalendarLink').href = calendarUrl;
        }

        function calculateMean(arr) { if (arr.length === 0) return 0; return arr.reduce((a, b) => a + b, 0) / arr.length; }
        function calculateMedian(arr) { if (arr.length === 0) return 0; const sorted = [...arr].sort((a, b) => a - b); const mid = Math.floor(sorted.length / 2); return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2; }

        function calculateMedianReport() {
            const costs = inventoryData.map(i => i.cost);
            const salesPrices = inventoryData.map(i => i.sale);
            document.getElementById('meanCostDisplay').innerText = `R$ ${calculateMean(costs).toFixed(2)}`;
            document.getElementById('medianCostDisplay').innerText = `R$ ${calculateMedian(costs).toFixed(2)}`;
            document.getElementById('meanSaleDisplay').innerText = `R$ ${calculateMean(salesPrices).toFixed(2)}`;
            document.getElementById('medianSaleDisplay').innerText = `R$ ${calculateMedian(salesPrices).toFixed(2)}`;
            const tbody = document.getElementById('medianListBody');
            tbody.innerHTML = '';
            inventoryData.forEach(item => {
                const diff = item.cost - item.lastCost;
                const percent = item.lastCost > 0 ? (diff / item.lastCost) * 100 : 0;
                let trendIcon = '➖'; let trendClass = 'trend-neutral'; let trendText = '0%';
                if (diff > 0) { trendIcon = '▲'; trendClass = 'trend-up'; trendText = `+${percent.toFixed(0)}%`; }
                else if (diff < 0) { trendIcon = '▼'; trendClass = 'trend-down'; trendText = `${percent.toFixed(0)}%`; }
                const minMarkupPrice = item.cost * 2; const floorPrice = item.sale;
                const idealPrice = Math.max(minMarkupPrice, floorPrice);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-700 font-medium">${item.model}</td>
                    <td class="px-2 py-3 text-right text-sm text-gray-500">R$ ${item.cost.toFixed(2)}</td>
                    <td class="px-2 py-3 text-center text-sm font-bold ${trendClass}">${trendIcon} ${trendText}</td>
                    <td class="px-2 py-3 text-right text-sm text-gray-700">R$ ${item.sale.toFixed(2)}</td>
                    <td class="px-2 py-3 text-right text-sm font-bold text-indigo-700">R$ ${idealPrice.toFixed(2)}</td>
                    <td class="px-2 py-3 text-center text-sm text-gray-500">${item.sale >= idealPrice ? 'OK' : 'Baixo'}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('medianModal').style.display = 'block';
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = function(event) { if (event.target.classList.contains('modal')) event.target.style.display = "none"; }

        filterTable(); populateManualSelect();
    </script>
</body>
</html>